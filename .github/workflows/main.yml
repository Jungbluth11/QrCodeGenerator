name: Build & Release

on:
  push:
    branches:
    - master
    paths-ignore:
      - ".github/**"
      - "**/*.md"
      - "**/*.gitignore"
      - "**/*.gitattributes"
  workflow_dispatch:
  
env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true
  PROJECT_PATH: QrCodeGenerator/QrCodeGenerator.csproj
  WIN_INSTALLER_PATH: publish/install-win.iss
  DEB_PACKAGE_NAME: qrcodegenerator
  TARGET_FRAMEWORK: net10.0-desktop

jobs:
  build:
    strategy:
      matrix:
        os: [windows, linux]
    runs-on: ${{ matrix.os == 'windows' && 'windows-latest' || 'ubuntu-latest' }}

    outputs:
      version: ${{ steps.version.outputs.VERSION }}

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Read version from csproj
      id: version
      shell: pwsh
      run: |
        $xml = [xml](Get-Content "${{ env.PROJECT_PATH }}")
        $ver = $xml.Project.PropertyGroup.Version
        if (-not $ver) { throw "No <Version> found in csproj" }
        echo "VERSION=$ver" >> $env:GITHUB_OUTPUT

    - name: Publish
      shell: pwsh
      run: |
        if ($IsWindows) {
          dotnet publish "${PROJECT_PATH}" -c Release -f ${{ env.TARGET_FRAMEWORK }} --os win -p:PublishSingleFile=true --self-contained false -o publish/windows
        } else {
          dotnet publish "${PROJECT_PATH}" -c Release -f ${{ env.TARGET_FRAMEWORK }} --os linux -p:PublishSingleFile=true --self-contained false -o publish/linux/usr/bin/QrCodeGenerator
        }

    - name: Build Windows installer
      if: matrix.os == 'windows'
      shell: pwsh
      run: |
        choco install innosetup -y
        iscc "${{ env. WIN_INSTALLER_PATH }}" /DVERSION=${{ steps.version.outputs.VERSION }}

    - name: Upload Windows installer
      if: matrix.os == 'windows'
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: publish/Output/*.exe

    - name: Build Linux DEB
      if: matrix.os == 'linux'
      run: |
        sed -i "s/^Version: .*$/Version: ${{ steps.version.outputs.VERSION }}/" publish/linux//DEBIAN/control
        dpkg-deb --build publish/linux/ "${{ env.DEB_PACKAGE_NAME }}_${{ steps.version.outputs.VERSION }}.deb"

    - name: Upload Linux DEB
      if: matrix.os == 'linux'
      uses: actions/upload-artifact@v4
      with:
        name: linux-deb
        path: qrcodegenerator_${{ steps.version.outputs.VERSION }}.deb   

  release:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Download Windows installer
      uses: actions/download-artifact@v4
      with:
        name: windows-installer
        path: dist/windows

    - name: Download Linux DEB
      uses: actions/download-artifact@v4
      with:
        name: linux-deb
        path: dist/linux

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.build.outputs.version }}
        name: v${{ needs.build.outputs.version }}
        files: |
          dist/windows/*.exe
          dist/linux/*.deb
